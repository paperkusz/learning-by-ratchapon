<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á | ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏£‡∏ï‡∏û‡∏¥‡∏ó‡∏¢‡∏û‡∏¢‡∏±‡∏ï</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ... ‡∏Ñ‡πà‡∏≤ CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ... */
        /* ‡πÇ‡∏Ñ‡πâ‡∏î CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà */
        /* ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á */
    </style>
</head>
<body>
    <!-- ... ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ... -->
    <!-- ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
    
    <script>
    // ==========================
    //  CONFIG ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
    // ==========================

    // URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏•‡∏¢‡∏à‡∏≤‡∏Å GitHub (‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏¢‡∏Å)
    const ANSWER_KEY_URL = "https://raw.githubusercontent.com/RatchaponJKS/learning-by-ratchapon/main/exam-answer-key.json";
    
    // ‚úÖ URL Google Apps Script ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ä‡πâ deployment URL ‡∏à‡∏£‡∏¥‡∏á)
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbySe4Hv2VPvi736AyYq1vTofb2hSq3woG4XGz_sxyJDiHTt4I_T4Onlcvgb5l8sCjCC/exec";
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤ / ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    const SCHOOL_NAME   = "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏£‡∏ï‡∏û‡∏¥‡∏ó‡∏¢‡∏û‡∏¢‡∏±‡∏ï";
    const COURSE_NAME   = "‡∏ß‡∏¥‡∏ä‡∏≤‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á";
    const COURSE_CODE   = "‡∏ß30258";
    const EXAM_TITLE    = "‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ";
    const TERM          = "2";
    const ACADEMIC_YEAR = "2568";
    const ATTEMPT_NO    = 1;
    const TOTAL_TIME    = 60 * 60; // 60 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    document.getElementById("exam-title-text").textContent = `${COURSE_NAME} (${COURSE_CODE})`;
    document.getElementById("exam-heading").textContent    = EXAM_TITLE;
    document.getElementById("exam-subtitle-text").textContent =
        `${SCHOOL_NAME} | ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${TERM} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${ACADEMIC_YEAR} | ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${ATTEMPT_NO}`;

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    document.getElementById("course-name").value = COURSE_NAME;
    document.getElementById("course-code").value = COURSE_CODE;
    document.getElementById("exam-name").value   = EXAM_TITLE;
    document.getElementById("term-year").value   = `‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${TERM} / ${ACADEMIC_YEAR}`;
    document.getElementById("attempt-no").value  = ATTEMPT_NO;

    // ==========================
    // ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô LocalStorage ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IP
    // ==========================
    
    const STORAGE_KEY = 'advanced_robot_exam_submission_40';
    const IP_STORAGE_KEY = 'exam_ip_tracker_40';
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏¢‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    function checkPreviousSubmission() {
        const previousData = localStorage.getItem(STORAGE_KEY);
        
        if (previousData) {
            try {
                const data = JSON.parse(previousData);
                showAlreadySubmitted(data);
                return true;
            } catch (e) {
                console.error('Error parsing stored data:', e);
            }
        }
        
        return false;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
    function showAlreadySubmitted(previousData) {
        document.getElementById('start-exam').style.display = 'none';
        document.getElementById('already-submitted').style.display = 'block';
        
        if (previousData) {
            document.getElementById('previous-name').textContent = 
                `${previousData.firstName || ''} ${previousData.lastName || ''}`.trim() || '-';
            document.getElementById('previous-score').textContent = 
                `${previousData.score || 0}/${previousData.total || 40}`;
            document.getElementById('previous-date').textContent = 
                previousData.submitDate || new Date().toLocaleDateString('th-TH');
            document.getElementById('previous-time').textContent = 
                previousData.timeUsed || '00:00:00';
        }
        
        disableStartButton();
    }
    
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö
    function disableStartButton() {
        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-ban"></i> ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)';
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    document.addEventListener('DOMContentLoaded', function() {
        checkPreviousSubmission();
        
        window.addEventListener('beforeunload', function(e) {
            if (window.examStarted && !window.examFinished) {
                e.preventDefault();
                e.returnValue = '‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
            }
        });
    });

    // ==========================
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö 40 ‡∏Ç‡πâ‡∏≠ (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤)
    // ==========================
    const allQuestions = [
        {
            id: 1,
            question: "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Robot.forward(100); ‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?",
            options: [
                "‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 100 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ",
                "‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á 100 ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡πÄ‡∏°‡∏ï‡∏£",
                "‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß 100 ‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏ó‡∏µ",
                "‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
            ],
            scenario: false
        },
        // ... ‡∏Ç‡πâ‡∏≠ 2-40 ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ...
        // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 40 ‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
    ];

    // ==========================
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
    // ==========================
    let examQuestions = []; // ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 40 ‡∏Ç‡πâ‡∏≠ (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏∏‡πà‡∏°)
    let userAnswers = []; // ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö
    let answerKey = null; // ‡πÄ‡∏â‡∏•‡∏¢‡∏à‡∏≤‡∏Å GitHub
    let currentQuestionIndex = 0;
    let timeLeft = TOTAL_TIME;
    let timerInterval;
    let startTime;
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    window.examStarted = false;
    window.examFinished = false;

    const startBtn = document.getElementById('start-btn');
    const submitBtn = document.getElementById('submit-btn');
    const backBtn = document.getElementById('back-btn');

    startBtn.addEventListener('click', startExam);
    submitBtn.addEventListener('click', submitExam);
    backBtn.addEventListener('click', () => {
        window.location.href = '/learning-by-ratchapon/index.html';
    });

    // ==========================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡πÅ‡∏•‡∏∞ F12
    // ==========================
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'warning');
        return false;
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
            showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö', 'warning');
            return false;
        }
        
        if (window.examStarted && !window.examFinished && e.key === 'F5') {
            e.preventDefault();
            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'warning');
            return false;
        }
    });

    // ==========================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    // ==========================
    function showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // ==========================
    // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏•‡∏¢‡∏à‡∏≤‡∏Å GitHub
    // ==========================
    async function fetchAnswerKey() {
        try {
            const response = await fetch(ANSWER_KEY_URL + '?t=' + new Date().getTime());
            if (!response.ok) {
                throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏•‡∏¢‡πÑ‡∏î‡πâ');
            }
            answerKey = await response.json();
            console.log('‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏•‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } catch (error) {
            console.error('Error fetching answer key:', error);
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏•‡∏¢‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏•‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á (encoded ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î)
            answerKey = generateBackupAnswerKey();
            showNotification('‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏•‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå', 'warning');
        }
    }

    // ‡πÄ‡∏â‡∏•‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏ö‡∏ö encoded)
    function generateBackupAnswerKey() {
        // ‡πÄ‡∏â‡∏•‡∏¢‡∏ñ‡∏π‡∏Å encode ‡πÄ‡∏õ‡πá‡∏ô base64 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡πÜ
        const encodedAnswers = {
            mc: "WzEsMywyLDEsMiwyLDIsMiwxLDIsMSwyLDIsMSwyLDIsMiwxLDIsMiwyLDIsMSwxLDIsMSwyLDEsMiwxLDIsMSwxLDIsMiwxLDIsMSwxLDJd"
        };
        
        return {
            answers: JSON.parse(atob(encodedAnswers.mc))
        };
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö GAS
    async function testGASConnection() {
        try {
            const response = await fetch(SHEET_API_URL + '?test=' + new Date().getTime(), {
                method: 'GET',
                mode: 'no-cors'
            });
            return true;
        } catch (error) {
            console.error('GAS Connection Test Failed:', error);
            return false;
        }
    }

    // ==========================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö
    // ==========================
    async function startExam() {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (localStorage.getItem(STORAGE_KEY)) {
            showNotification('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'error');
            const previousData = JSON.parse(localStorage.getItem(STORAGE_KEY));
            showAlreadySubmitted(previousData);
            return;
        }

        const firstName = document.getElementById('student-firstname').value.trim();
        const lastName  = document.getElementById('student-lastname').value.trim();
        const number    = document.getElementById('student-number').value.trim();
        const room      = document.getElementById('student-room').value.trim();

        if (!firstName || !lastName || !number || !room) {
            showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'error');
            return;
        }

        // ‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö GAS ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö...', 'info');
        
        const isConnected = await testGASConnection();
        if (!isConnected) {
            showNotification('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', 'warning');
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö
        window.studentInfo = { firstName, lastName, number, room };

        // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏•‡∏¢‡∏à‡∏≤‡∏Å GitHub
        await fetchAnswerKey();

        // ‡∏™‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠)
        examQuestions = shuffleArray([...allQuestions]);
        userAnswers = new Array(examQuestions.length).fill(null);

        document.getElementById('start-exam').style.display = 'none';
        document.getElementById('question-container').style.display = 'block';
        document.getElementById('progress-container').style.display = 'block';

        renderAllQuestions();
        renderProgressButtons();

        startTime = new Date();
        timeLeft = TOTAL_TIME;
        startTimer();
        scrollToQuestion(0);
        
        window.examStarted = true;
        
        showNotification('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á! ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ 60 ‡∏ô‡∏≤‡∏ó‡∏µ', 'info');
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function renderAllQuestions() {
        const questionsElement = document.getElementById('questions');
        questionsElement.innerHTML = '';

        // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        const section1Header = document.createElement('div');
        section1Header.className = 'section-header';
        section1Header.innerHTML = `<i class="fas fa-list-ol"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (20 ‡∏Ç‡πâ‡∏≠)`;
        questionsElement.appendChild(section1Header);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠ 1-20
        examQuestions.slice(0, 20).forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';
            questionDiv.id = `question-${index}`;

            const questionNumber = document.createElement('div');
            questionNumber.className = 'question-number';
            questionNumber.innerHTML = `<i class="fas fa-question-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1} <span style="font-size: 0.9rem; color: #666; margin-left: 1rem;">(${q.category})</span>`;

            const questionText = document.createElement('div');
            questionText.className = 'question-text';
            questionText.innerHTML = q.question;

            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options';

            questionDiv.appendChild(questionNumber);
            questionDiv.appendChild(questionText);

            q.options.forEach((option, optionIndex) => {
                const optionDiv = document.createElement('label');
                optionDiv.className = 'option';

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = `question-${index}`;
                input.value = optionIndex;

                const span = document.createElement('span');
                span.innerHTML = option;

                optionDiv.appendChild(input);
                optionDiv.appendChild(span);

                optionDiv.addEventListener('click', () => {
                    optionsDiv.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });

                    optionDiv.classList.add('selected');
                    userAnswers[index] = optionIndex;
                    updateProgressButtons();

                    // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    if (index < 19) {
                        setTimeout(() => {
                            scrollToQuestion(index + 1);
                        }, 300);
                    }
                });

                optionsDiv.appendChild(optionDiv);
            });

            questionDiv.appendChild(optionsDiv);
            questionsElement.appendChild(questionDiv);
        });

        // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
        const section2Header = document.createElement('div');
        section2Header.className = 'section-header';
        section2Header.innerHTML = `<i class="fas fa-scroll"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå (20 ‡∏Ç‡πâ‡∏≠)`;
        questionsElement.appendChild(section2Header);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠ 21-40
        examQuestions.slice(20, 40).forEach((q, index) => {
            const globalIndex = index + 20;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';
            questionDiv.id = `question-${globalIndex}`;

            const questionNumber = document.createElement('div');
            questionNumber.className = 'question-number';
            questionNumber.innerHTML = `<i class="fas fa-question-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${globalIndex + 1} <span style="font-size: 0.9rem; color: #666; margin-left: 1rem;">(‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå)</span>`;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
            if (q.scenario && q.scenarioText) {
                const scenarioBox = document.createElement('div');
                scenarioBox.className = 'scenario-box';
                
                const scenarioTitle = document.createElement('div');
                scenarioTitle.className = 'scenario-title';
                scenarioTitle.innerHTML = `<i class="fas fa-map-marker-alt"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå`;
                
                const scenarioText = document.createElement('div');
                scenarioText.textContent = q.scenarioText;
                
                scenarioBox.appendChild(scenarioTitle);
                scenarioBox.appendChild(scenarioText);
                questionDiv.appendChild(scenarioBox);
            }

            const questionText = document.createElement('div');
            questionText.className = 'question-text';
            questionText.innerHTML = q.question;

            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options';

            questionDiv.appendChild(questionNumber);
            questionDiv.appendChild(questionText);

            q.options.forEach((option, optionIndex) => {
                const optionDiv = document.createElement('label');
                optionDiv.className = 'option';

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = `question-${globalIndex}`;
                input.value = optionIndex;

                const span = document.createElement('span');
                span.innerHTML = option;

                optionDiv.appendChild(input);
                optionDiv.appendChild(span);

                optionDiv.addEventListener('click', () => {
                    optionsDiv.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });

                    optionDiv.classList.add('selected');
                    userAnswers[globalIndex] = optionIndex;
                    updateProgressButtons();

                    // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    if (globalIndex < 39) {
                        setTimeout(() => {
                            scrollToQuestion(globalIndex + 1);
                        }, 300);
                    }
                });

                optionsDiv.appendChild(optionDiv);
            });

            questionDiv.appendChild(optionsDiv);
            questionsElement.appendChild(questionDiv);
        });
    }

    // ‡πÅ‡∏ñ‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    function renderProgressButtons() {
        const progressButtons = document.getElementById('progress-buttons');
        progressButtons.innerHTML = '';

        const totalQuestions = examQuestions.length;
        
        for (let i = 0; i < totalQuestions; i++) {
            const btn = document.createElement('button');
            btn.className = 'progress-btn';
            btn.textContent = i + 1;
            btn.addEventListener('click', () => scrollToQuestion(i));
            progressButtons.appendChild(btn);
        }

        updateProgressButtons();
    }

    function updateProgressButtons() {
        const buttons = document.querySelectorAll('.progress-btn');
        let hasUnanswered = false;

        buttons.forEach((btn, index) => {
            let answered = userAnswers[index] !== null;

            if (answered) {
                btn.classList.add('answered');
            } else {
                btn.classList.remove('answered');
                hasUnanswered = true;
            }

            btn.classList.remove('current');
            if (index === currentQuestionIndex) {
                btn.classList.add('current');
            }
        });

        document.getElementById('unanswered-warning').style.display =
            hasUnanswered ? 'block' : 'none';
    }

    function scrollToQuestion(index) {
        currentQuestionIndex = index;
        
        const questionElement = document.getElementById(`question-${index}`);
        if (questionElement) {
            questionElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        updateProgressButtons();
    }

    // ==========================
    // Timer (60 ‡∏ô‡∏≤‡∏ó‡∏µ)
    // ==========================
    function startTimer() {
        updateTimerDisplay();

        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showNotification('‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'warning');
                submitExam();
            }

            if (timeLeft <= 60) {
                document.getElementById('timer').classList.add('danger');
            } else if (timeLeft <= 5 * 60) {
                document.getElementById('timer').classList.add('warning');
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const hours   = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        const seconds = timeLeft % 60;

        document.getElementById('timer').textContent =
            `${hours.toString().padStart(2, '0')}:` +
            `${minutes.toString().padStart(2, '0')}:` +
            `${seconds.toString().padStart(2, '0')}`;
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
    function saveForLaterRetry(data) {
        try {
            const pendingData = JSON.parse(localStorage.getItem('pending_sheet_data') || '[]');
            pendingData.push({
                data: data,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('pending_sheet_data', JSON.stringify(pendingData));
            console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } catch (e) {
            console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ:', e);
        }
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á
    async function retryPendingData() {
        try {
            const pendingData = JSON.parse(localStorage.getItem('pending_sheet_data') || '[]');
            if (pendingData.length === 0) return;
            
            console.log(`‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ${pendingData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            
            for (let i = 0; i < pendingData.length; i++) {
                const item = pendingData[i];
                try {
                    await sendToGoogleSheetsDirect(item.data);
                    // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á
                    pendingData.splice(i, 1);
                    i--;
                    localStorage.setItem('pending_sheet_data', JSON.stringify(pendingData));
                } catch (error) {
                    console.error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i} ‡πÑ‡∏î‡πâ:`, error);
                }
            }
        } catch (e) {
            console.error('Error retrying pending data:', e);
        }
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö direct (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö retry)
    async function sendToGoogleSheetsDirect(data) {
        return new Promise((resolve, reject) => {
            fetch(SHEET_API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                console.log('‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                resolve(true);
            })
            .catch(error => {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡πÑ‡∏î‡πâ:', error);
                reject(error);
            });
        });
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
function sendToGoogleSheets(data) {
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbySe4Hv2VPvi736AyYq1vTofb2hSq3woG4XGz_sxyJDiHTt4I_T4Onlcvgb5l8sCjCC/exec";
    
    const sheetData = {
        action: 'submitAdvancedRobotExam',
        studentInfo: {
            firstName: data.firstName,
            lastName: data.lastName,
            number: data.number,
            room: data.room
        },
        examInfo: {
            courseName: data.courseName,
            courseCode: data.courseCode,
            examTitle: data.examTitle,
            term: "2",
            academicYear: "2568",
            attemptNo: 1
        },
        result: {
            score: data.score,
            total: data.total,
            correct: data.correctAnswers,
            wrong: data.wrongAnswers,
            unanswered: data.unanswered,
            timeUsed: data.timeUsed,
            percentage: Math.round((data.score / data.total) * 100)
        },
        submissionInfo: {
            submitDate: data.submitDate,
            submitTime: data.submitTime,
            timestamp: data.timestamp
        }
    };

    console.log('üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets:', sheetData);
    
    // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö form data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS
    const formData = new FormData();
    formData.append('data', JSON.stringify(sheetData));
    
    fetch(SHEET_API_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: formData
    })
    .then(() => {
        console.log('‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (no-cors mode)');
        showNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        
        // ‚úÖ ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢
        setTimeout(() => {
            retryPendingData();
        }, 2000);
    })
    .catch(error => {
        console.error('‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', error);
        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
        saveForLaterRetry(sheetData);
        showNotification('‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)', 'warning');
    });
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
function saveForLaterRetry(data) {
    try {
        const pendingData = JSON.parse(localStorage.getItem('pending_sheet_data') || '[]');
        pendingData.push({
            data: data,
            timestamp: new Date().toISOString(),
            attempt: 1
        });
        localStorage.setItem('pending_sheet_data', JSON.stringify(pendingData));
        console.log('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', pendingData.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    } catch (e) {
        console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ:', e);
    }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á
async function retryPendingData() {
    try {
        const pendingData = JSON.parse(localStorage.getItem('pending_sheet_data') || '[]');
        if (pendingData.length === 0) return;
        
        console.log(`üîÑ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ${pendingData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        
        for (let i = 0; i < pendingData.length; i++) {
            const item = pendingData[i];
            const formData = new FormData();
            formData.append('data', JSON.stringify(item.data));
            
            try {
                await fetch(SHEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });
                
                console.log(`‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i + 1} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á
                pendingData.splice(i, 1);
                i--;
                localStorage.setItem('pending_sheet_data', JSON.stringify(pendingData));
                
            } catch (error) {
                console.error(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i + 1} ‡πÑ‡∏î‡πâ:`, error);
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°
                if (item.attempt) {
                    item.attempt++;
                } else {
                    item.attempt = 1;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
                if (item.attempt > 3) {
                    console.log(`üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i + 1} ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);
                    pendingData.splice(i, 1);
                    i--;
                    localStorage.setItem('pending_sheet_data', JSON.stringify(pendingData));
                }
            }
        }
    } catch (e) {
        console.error('Error retrying pending data:', e);
    }
}

    // ==========================
    // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    // ==========================
    function submitExam() {
        clearInterval(timerInterval);
        
        window.examFinished = true;
        window.examStarted = false;

        const endTime  = new Date();
        const timeUsed = startTime ? Math.floor((endTime - startTime) / 1000) : 0;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
        let correct = 0;
        let wrong = 0;
        let unanswered = 0;
        
        if (answerKey && answerKey.answers) {
            examQuestions.forEach((q, index) => {
                if (userAnswers[index] === null) {
                    unanswered++;
                } else if (userAnswers[index] === answerKey.answers[index]) {
                    correct++;
                } else {
                    wrong++;
                }
            });
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage
        const resultData = {
            firstName: window.studentInfo.firstName,
            lastName: window.studentInfo.lastName,
            number: window.studentInfo.number,
            room: window.studentInfo.room,
            courseName: COURSE_NAME,
            courseCode: COURSE_CODE,
            examTitle: EXAM_TITLE,
            score: correct,
            total: examQuestions.length,
            correctAnswers: correct,
            wrongAnswers: wrong,
            unanswered: unanswered,
            timeUsed: formatTime(timeUsed),
            timeUsedSeconds: timeUsed,
            submitDate: new Date().toLocaleDateString('th-TH'),
            submitTime: new Date().toLocaleTimeString('th-TH'),
            timestamp: new Date().toISOString(),
            section1: {
                score: correct,
                total: examQuestions.length
            }
        };

        localStorage.setItem(STORAGE_KEY, JSON.stringify(resultData));
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å IP
        try {
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    const ipInfo = {
                        ip: data.ip,
                        timestamp: new Date().toISOString(),
                        submitted: true
                    };
                    localStorage.setItem(IP_STORAGE_KEY, JSON.stringify(ipInfo));
                })
                .catch(() => {
                    const ipInfo = {
                        ip: 'unknown',
                        timestamp: new Date().toISOString(),
                        submitted: true
                    };
                    localStorage.setItem(IP_STORAGE_KEY, JSON.stringify(ipInfo));
                });
        } catch (e) {
            console.log('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å IP ‡πÑ‡∏î‡πâ:', e);
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        showResult(resultData);
        
        // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
        sendToGoogleSheets(resultData);
        
        disableStartButton();
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    function showResult(data) {
        document.getElementById('question-container').style.display = 'none';
        document.getElementById('progress-container').style.display = 'none';
        document.getElementById('result-container').style.display = 'block';

        document.getElementById('score').textContent = `${data.score}/${data.total}`;
        document.getElementById('correct-answers').textContent = data.correctAnswers;
        document.getElementById('wrong-answers').textContent = data.wrongAnswers;
        document.getElementById('unanswered').textContent = data.unanswered;
        document.getElementById('time-used').textContent = data.timeUsed;

        const percentage = Math.round((data.score / data.total) * 100);
        const scoreElement = document.getElementById('score');
        
        if (percentage >= 80) {
            scoreElement.style.color = "#33cc33";
        } else if (percentage >= 50) {
            scoreElement.style.color = "#ff9900";
        } else {
            scoreElement.style.color = "#ff3333";
        }
        
        showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Utility: ‡∏™‡∏∏‡πà‡∏° array
    function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            retryPendingData();
        }, 3000);
    });
    </script>
</body>
</html>
