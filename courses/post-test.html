// === ตั้งค่า SHEET_ID และ SHEET_NAME ที่นี่ ===
const SHEET_ID   = "1JSWrx2bx5aYBsAFJv6DKpvXQjWsHDhnupWDeN6VghCU";      // ใส่ไอดีชีต
const SHEET_NAME = "Responses";               // ชื่อชีตที่เก็บข้อมูล

function doPost(e) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);

    // สร้างหัวตารางถ้ายังไม่มี
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        "Timestamp",
        "ชื่อ",
        "นามสกุล",
        "เลขที่",
        "ห้อง",
        "คะแนน (เช่น 30/40)",
        "ถูก",
        "ผิด",
        "ไม่ได้ตอบ",
        "จำนวนข้อทั้งหมด",
        "เวลาใช้ (วินาที)",
        "คำตอบ (array)"
      ]);
    }

    const raw = e.postData && e.postData.contents ? e.postData.contents : "{}";
    const data = JSON.parse(raw);

    const now = new Date();

    sheet.appendRow([
      now,
      data.firstName || "",
      data.lastName || "",
      data.number || "",
      data.room || "",
      data.scoreText || "",
      data.correct || 0,
      data.wrong || 0,
      data.unanswered || 0,
      data.total || "",
      data.timeUsedSeconds || 0,
      JSON.stringify(data.answers || [])
    ]);

    return ContentService
      .createTextOutput(JSON.stringify({ ok: true }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log(err);
    return ContentService
      .createTextOutput(JSON.stringify({ ok: false, error: String(err) }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
